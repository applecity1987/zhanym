<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ß–∞—Ç ‚Äî Zhanym</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Arial,sans-serif;background:#f5f5f5;height:100vh;display:flex;flex-direction:column}
.header{background:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.logo{font-size:24px;font-weight:bold;color:#ff6b6b}
.nav a{margin-left:15px;text-decoration:none;color:#666;font-size:14px}
.chat-container{display:flex;flex:1;overflow:hidden;max-width:900px;margin:20px auto;width:100%;gap:20px;padding:0 20px}
.matches-list{width:280px;background:white;border-radius:20px;overflow-y:auto;box-shadow:0 5px 20px rgba(0,0,0,.1)}
.matches-title{padding:20px;font-weight:bold;color:#333;border-bottom:1px solid #eee}
.match-item{padding:15px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;border-bottom:1px solid #f5f5f5}
.match-item:hover{background:#fff5f5}
.match-item.active{background:#fff0f0}
.match-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#ff6b6b,#fd79a8);display:flex;align-items:center;justify-content:center;font-size:20px}
.chat-area{flex:1;background:white;border-radius:20px;display:flex;flex-direction:column;box-shadow:0 5px 20px rgba(0,0,0,.1)}
.chat-header{padding:20px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px}
.chat-avatar{width:45px;height:45px;border-radius:50%;background:linear-gradient(135deg,#ff6b6b,#fd79a8);display:flex;align-items:center;justify-content:center;font-size:20px}
.chat-name{font-weight:bold;color:#333}
.chat-status{color:#aaa;font-size:12px}
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:70%;padding:12px 16px;border-radius:18px;font-size:15px;line-height:1.4}
.msg.sent{background:linear-gradient(135deg,#ff6b6b,#fd79a8);color:white;align-self:flex-end}
.msg.received{background:#f5f5f5;color:#333;align-self:flex-start}
.msg-time{font-size:11px;opacity:.7;margin-top:4px}
.chat-input{padding:15px 20px;border-top:1px solid #eee;display:flex;gap:10px}
.chat-input input{flex:1;padding:12px 16px;border:2px solid #eee;border-radius:25px;font-size:15px;outline:none}
.chat-input input:focus{border-color:#ff6b6b}
.chat-input button{padding:12px 20px;background:linear-gradient(135deg,#ff6b6b,#fd79a8);color:white;border:none;border-radius:25px;cursor:pointer;font-size:18px}
.empty-chat{flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;color:#aaa}
.no-matches{padding:30px;text-align:center;color:#aaa}
</style>
</head>
<body>
<div class="header">
  <a href="/" style="text-decoration:none;color:#ff6b6b;font-size:24px;font-weight:bold;">üåπ Zhanym</a>
  <div class="nav">
    <a href="/dashboard">–õ–µ–Ω—Ç–∞</a>
    <a href="/profile">–ü—Ä–æ—Ñ–∏–ª—å</a>
    <a href="/chat">–ß–∞—Ç</a>
    <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
  </div>
</div>
<div class="chat-container">
  <div class="matches-list">
    <div class="matches-title">üíû –ü–∞—Ä—ã</div>
    <div id="matchesList"></div>
  </div>
  <div class="chat-area">
    <div class="chat-header" id="chatHeader" style="display:none">
      <div class="chat-avatar" id="chatAvatar">üë§</div>
      <div>
        <div class="chat-name" id="chatName"></div>
        <div class="chat-status">–æ–Ω–ª–∞–π–Ω</div>
      </div>
    </div>
    <div class="messages" id="messages">
      <div class="empty-chat">
        <h3>–í—ã–±–µ—Ä–∏ –ø–∞—Ä—É</h3>
        <p>–ù–∞—á–Ω–∏ –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–Ω—Ä–∞–≤–∏–≤—à–∏–º—Å—è —á–µ–ª–æ–≤–µ–∫–æ–º</p>
      </div>
    </div>
    <div class="chat-input" id="chatInput" style="display:none">
      <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
      <button id="sendBtn">‚û§</button>
    </div>
  </div>
</div>
<script>
const token = localStorage.getItem('token');
if(!token) window.location.href = '/login';
let currentMatchId = null;
let ws = null;
let myId = null;

document.getElementById('messageInput').addEventListener('keypress', function(e){
  if(e.key === 'Enter') sendMessage();
});
document.getElementById('sendBtn').addEventListener('click', sendMessage);

async function loadMe() {
  const res = await fetch('/users/me', {headers:{'Authorization':'Bearer '+token}});
  if(res.status===401){ window.location.href='/login'; return; }
  const me = await res.json();
  myId = me.id;
  loadMatches();
}

async function loadMatches() {
  try {
    const res = await fetch('/search/matches', {headers:{'Authorization':'Bearer '+token}});
    const matches = await res.json();
    renderMatches(matches);
  } catch(e){ console.log(e); }
}

function renderMatches(matches) {
  const list = document.getElementById('matchesList');
  if(!matches || !matches.length){
    list.innerHTML = '<div class="no-matches">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Ä.<br>–õ–∞–π–∫–∞–π –±–æ–ª—å—à–µ!</div>';
    return;
  }
  list.innerHTML = '';
  matches.forEach(function(m) {
    const div = document.createElement('div');
    div.className = 'match-item';
    div.id = 'match-' + m.id;
    div.innerHTML = '<div class="match-avatar">' + (m.gender==='female' ? 'üë©' : 'üë®') + '</div><div><div style="font-weight:bold;font-size:14px">' + m.name + ', ' + m.age + '</div><div style="color:#aaa;font-size:12px">' + m.city + '</div></div>';
    div.addEventListener('click', function(){ openChat(m.id, m.name, m.gender); });
    list.appendChild(div);
  });
}

async function openChat(userId, name, gender) {
  currentMatchId = userId;
  document.querySelectorAll('.match-item').forEach(function(el){ el.classList.remove('active'); });
  const el = document.getElementById('match-'+userId);
  if(el) el.classList.add('active');
  document.getElementById('chatHeader').style.display = 'flex';
  document.getElementById('chatInput').style.display = 'flex';
  document.getElementById('chatName').textContent = name;
  document.getElementById('chatAvatar').textContent = gender === 'female' ? 'üë©' : 'üë®';
  if(ws) ws.close();
  ws = new WebSocket('ws://127.0.0.1:8000/chat/ws/'+myId);
  ws.onmessage = function(e) {
    const data = JSON.parse(e.data);
    addMessage(data.message, 'received', data.time);
  };
  loadHistory(userId);
}

async function loadHistory(userId) {
  try {
    const res = await fetch('/chat/history/'+userId, {headers:{'Authorization':'Bearer '+token}});
    const msgs = await res.json();
    const container = document.getElementById('messages');
    container.innerHTML = '';
    msgs.forEach(function(m){ addMessage(m.content, m.sender_id === myId ? 'sent' : 'received', m.created_at); });
  } catch(e){
    document.getElementById('messages').innerHTML = '';
  }
}

function addMessage(text, type, time) {
  const container = document.getElementById('messages');
  const div = document.createElement('div');
  div.className = 'msg ' + type;
  const t = time ? new Date(time).toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'}) : '';
  div.innerHTML = text + '<div class="msg-time">'+t+'</div>';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if(!text || !currentMatchId) return;
  if(ws && ws.readyState === 1) {
    ws.send(JSON.stringify({receiver_id: currentMatchId, message: text}));
  }
  addMessage(text, 'sent', new Date().toISOString());
  input.value = '';
}

function logout(){ localStorage.removeItem('token'); window.location.href='/'; }
loadMe();
</script>
</body>
</html>